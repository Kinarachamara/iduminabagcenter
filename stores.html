<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Inventory Dashboard - Sold & Store Items with Keywords</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
  h1, h2 { margin-bottom: 10px; }
  select, input { padding: 8px; margin: 10px 5px 20px 0; font-size: 16px; }
  table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 40px;}
  th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
  th { background-color: #333; color: white; }

  /* Loader styles */
  #loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-weight: bold;
    color: #444;
    margin: 20px 0;
  }

  .loader {
    display: flex;
    gap: 5px;
  }

  .dot {
    width: 10px;
    height: 10px;
    background-color: #4CAF50;
    border-radius: 50%;
    animation: bounce 1s infinite ease-in-out;
  }

  .dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-12px);
    }
  }
</style>
</head>
<body>

<h1>Store Inventory Dashboard</h1>

<label for="typeFilter">Select Item Type:</label>
<select id="typeFilter">
  <option value="">-- All Types --</option>
</select>

<label for="keywordSearch">Search by Item Name or Keywords:</label>
<input type="text" id="keywordSearch" placeholder="Type keywords here..." />

<div id="loading">
  <div class="loader">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
  <span>Loading data...</span>
</div>

<h2>Store Items (Remaining Quantity)</h2>
<table>
  <thead>
    <tr>
      <th>Item Name</th><th>Price</th><th>Quantity In Store</th><th>Status</th><th>Type</th>
    </tr>
  </thead>
  <tbody id="tableBodyStore"></tbody>
</table>

<h2>Sell Items (Sold Quantity)</h2>
<table>
  <thead>
    <tr>
      <th>Item Name</th><th>Price</th><th>Quantity Sold</th><th>Status</th><th>Type</th>
    </tr>
  </thead>
  <tbody id="tableBodySell"></tbody>
</table>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1v1EvjD8dJaip7Liey97Gc_0SQ7ijAW22CQa2Ero4DKs/gviz/tq?tqx=out:json";

let allData = [];

async function fetchData() {
  document.getElementById('loading').style.display = 'flex';
  try {
    const res = await fetch(SHEET_URL);
    const text = await res.text();
    const jsonData = JSON.parse(text.substring(47, text.length - 2));
    const rows = jsonData.table.rows;

    allData = rows.map(row => {
      const c = row.c;
      return {
        item_id: c[0]?.v ?? "",
        item_name: c[1]?.v ?? "",
        item_price: c[2]?.v ?? 0,
        status: c[3]?.v ?? "",
        type: c[4]?.v ?? "",
        keywords: (c[5]?.v ?? "").toLowerCase()
      };
    });

    populateDropdown();
    filterAndRender();

  } catch (error) {
    alert("Error loading data: " + error);
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function populateDropdown() {
  const select = document.getElementById("typeFilter");
  select.innerHTML = '<option value="">-- All Types --</option>';

  const types = [...new Set(allData.map(item => item.type))];
  types.forEach(type => {
    const option = document.createElement("option");
    option.value = type;
    option.textContent = type;
    select.appendChild(option);
  });
}

function filterAndRender() {
  const type = document.getElementById("typeFilter").value.toLowerCase();
  const keyword = document.getElementById("keywordSearch").value.toLowerCase();

  let filtered = allData;

  if (type) {
    filtered = filtered.filter(item => item.type.toLowerCase() === type);
  }
  if (keyword) {
    filtered = filtered.filter(item =>
      item.item_name.toLowerCase().includes(keyword) ||
      item.keywords.includes(keyword)
    );
  }

  const grouped = groupItemsByName(filtered);
  renderTables(grouped);
}

function groupItemsByName(items) {
  const map = new Map();

  items.forEach(item => {
    const key = item.item_name.trim().toLowerCase();

    if (!map.has(key)) {
      map.set(key, {
        item_name: item.item_name,
        item_price: item.item_price,
        quantity_sold: 0,
        quantity_store: 0,
        type: item.type
      });
    }

    const entry = map.get(key);
    if (item.status.trim().toLowerCase() === "sell") {
      entry.quantity_sold += 1;
    } else if (item.status.trim().toLowerCase() === "non sell") {
      entry.quantity_store += 1;
    }
  });

  return Array.from(map.values());
}

function renderTables(items) {
  const tbodySell = document.getElementById("tableBodySell");
  const tbodyStore = document.getElementById("tableBodyStore");
  tbodySell.innerHTML = "";
  tbodyStore.innerHTML = "";

  const sellItems = items.filter(i => i.quantity_sold > 0);
  const storeItems = items.filter(i => i.quantity_store > 0);

  if (sellItems.length === 0) {
    tbodySell.innerHTML = '<tr><td colspan="5">No sell items found.</td></tr>';
  } else {
    sellItems.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.item_name}</td>
        <td>${item.item_price}</td>
        <td>${item.quantity_sold}</td>
        <td>Sell</td>
        <td>${item.type}</td>
      `;
      tbodySell.appendChild(tr);
    });
  }

  if (storeItems.length === 0) {
    tbodyStore.innerHTML = '<tr><td colspan="5">No store items found.</td></tr>';
  } else {
    storeItems.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.item_name}</td>
        <td>${item.item_price}</td>
        <td>${item.quantity_store}</td>
        <td>Non Sell</td>
        <td>${item.type}</td>
      `;
      tbodyStore.appendChild(tr);
    });
  }
}

document.getElementById("typeFilter").addEventListener("change", filterAndRender);
document.getElementById("keywordSearch").addEventListener("input", filterAndRender);

fetchData();
</script>

</body>
</html>

